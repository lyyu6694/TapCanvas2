services:
  web:
    image: ${DOCKERHUB_REGISTRY:-docker.1ms.run}/library/node:20-bookworm-slim
    working_dir: /app
    command: sh -lc "sh ./scripts/docker-dev.sh pnpm --filter @tapcanvas/web dev --host 0.0.0.0 --port 5173"
    env_file:
      - .env.docker
    environment:
      NODE_ENV: development
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "5173:5173"
    depends_on:
      api:
        condition: service_healthy
    volumes:
      - .:/app
      - root_node_modules:/app/node_modules
      - pnpm_store:/app/.pnpm-store
      - web_node_modules:/app/apps/web/node_modules
      - schemas_node_modules:/app/packages/schemas/node_modules
      - sdk_node_modules:/app/packages/sdk/node_modules

  api:
    image: ${DOCKERHUB_REGISTRY:-docker.1ms.run}/library/node:20-bookworm-slim
    working_dir: /app
    command: sh -lc "sh ./scripts/docker-dev.sh sh -lc 'pnpm --filter cloudflare-workers-openapi db:update:local && pnpm --filter cloudflare-workers-openapi dev --ip 0.0.0.0'"
    env_file:
      - .env.docker
    environment:
      NODE_ENV: development
    ports:
      - "8788:8788"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"fetch('http://127.0.0.1:8788/').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\"",
        ]
      interval: 5s
      timeout: 2s
      retries: 20
      start_period: 20s
    volumes:
      - .:/app
      - root_node_modules:/app/node_modules
      - pnpm_store:/app/.pnpm-store
      - hono_api_node_modules:/app/apps/hono-api/node_modules
      - schemas_node_modules:/app/packages/schemas/node_modules
      - sdk_node_modules:/app/packages/sdk/node_modules
      - hono_api_wrangler:/app/apps/hono-api/.wrangler

  # Optional: LangGraph (for LangGraph Chat Overlay)
  langgraph-redis:
    image: ${DOCKERHUB_REGISTRY:-docker.1ms.run}/library/redis:6
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 1s
      retries: 5

  langgraph-postgres:
    image: ${DOCKERHUB_REGISTRY:-docker.1ms.run}/library/postgres:16
    ports:
      - "5433:5432"
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - langgraph_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      start_period: 10s
      timeout: 1s
      retries: 5
      interval: 5s

  langgraph-api:
    platform: linux/amd64
    build:
      context: ./apps/ai-fullstack/backend
      dockerfile: Dockerfile
      args:
        DOCKERHUB_REGISTRY: ${DOCKERHUB_REGISTRY:-docker.1ms.run}
        PIP_INDEX_URL: ${PIP_INDEX_URL:-https://pypi.org/simple}
        PIP_EXTRA_INDEX_URL: ${PIP_EXTRA_INDEX_URL:-}
        PIP_TRUSTED_HOST: ${PIP_TRUSTED_HOST:-}
    ports:
      - "8123:8080"
    depends_on:
      langgraph-redis:
        condition: service_healthy
      langgraph-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8080/ok').read();\""]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 30s
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-}
      # Docker/Colima may inject a localhost proxy (e.g. 127.0.0.1:1087) which breaks outbound calls.
      HTTP_PROXY: ""
      HTTPS_PROXY: ""
      ALL_PROXY: ""
      http_proxy: ""
      https_proxy: ""
      all_proxy: ""
      NO_PROXY: "localhost,127.0.0.1,host.docker.internal"
      # Allow LangSmith Studio to connect to local dev server.
      # Note: when credentials are used, wildcard (*) cannot be used for Access-Control-Allow-Origin.
      CORS_ALLOW_ORIGINS: ${CORS_ALLOW_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173,https://smith.langchain.com}
      LANGSMITH_API_KEY: ${LANGSMITH_API_KEY:-}
      REDIS_URI: redis://langgraph-redis:6379
      POSTGRES_URI: postgres://postgres:postgres@langgraph-postgres:5432/postgres?sslmode=disable

volumes:
  root_node_modules:
    driver: local
  pnpm_store:
    driver: local
  web_node_modules:
    driver: local
  hono_api_node_modules:
    driver: local
  schemas_node_modules:
    driver: local
  sdk_node_modules:
    driver: local
  hono_api_wrangler:
    driver: local
  langgraph_data:
    driver: local
